# 批次总览(供应商运单号维度)统计优化PRD

**结论**
- 统一以供应商运单号(SupplierAWB)作为批次总览的统计维度，消除人工合并与重复统计问题
- 新增指标:【下单批次-出库订单量】【下单批次-出库重量/KG】，并将原有指标重命名为【出库批次-出库订单量】【出库批次-出库重量/KG】
- 统计口径严格遵循“去重、分包合并、状态唯一”的规则，保证数据准确性与幂等性
- 构建AWB批次映射模型(AWB↔下单批次号/出库批次号)，所有统计均以此映射为依据
- 提供批次总览查询接口，支持批次类型(order|outbound)、批次号、时间窗口、供应商过滤等参数

---

## 背景与价值
- 问题背景:中台每天需要手动合并大量相同供应商运单号的数据，频率高且易出错，影响效率与数据准确性
- 目标用户:中台部门
- 需求目标:提高批次总览模块数据统计的有效性与准确性，减少人工参与，提升一次性正确率
- 适用范围:国际物流批次总览模块(订单状态统计、出库订单量与重量统计)
- 需求价值:
  - 降低人工合并成本与错误率
  - 统一统计口径与维度，避免重复计算与口径不一致
  - 为运营决策提供可复用、可审计的统计依据

---

## 术语与口径
- SupplierAWB(供应商运单号):承运商/供应商的运单号，作为统计主维度
- OrderBatchNo(下单批次号):订单创建时的业务批次标识
- OutboundBatchNo(出库批次号):订单/包裹出库动作对应的批次标识
- Order(订单):业务订单实体，可能对应多个包裹/多个AWB(分包/拆分场景)
- Package(包裹):订单的出库单位，承载重量与体积等出库信息
- WeightKG(重量KG):出库称重的标准化重量(以KG为准)
- 状态枚举(用于“订单状态-数量”统计):订单生成、等待揽收、入库、出库、境外运输、境外仓、末端派送、完成、取消、丢件、退件、销毁

---

## 指标定义与重命名
- 新增指标
  - 下单批次-出库订单量:当前下单批次号对应SupplierAWB集合下的订单中，已发生“出库”状态的订单数量
  - 下单批次-出库重量/KG:当前下单批次号对应SupplierAWB集合下的包裹出库重量之和(KG)
- 原有指标重命名
  - 出库订单量→出库批次-出库订单量:统计维度为出库批次号对应SupplierAWB集合下的“出库订单数量”
  - 出库重量/KG→出库批次-出库重量/KG:统计维度为出库批次号对应SupplierAWB集合下的“出库重量之和(KG)”
- 订单状态-数量(按SupplierAWB维度):每个SupplierAWB当前的订单状态唯一确定，统计为“该AWB下订单的最新状态数量聚合”

---

## 统计规则(核心口径)
1) AWB批次映射模型
- 建立表AWB_Batch_Map:
  - awb: string(唯一)
  - order_batch_no: string
  - outbound_batch_no: string(可空)
  - first_order_id: string(用于追溯初始归属)
  - updated_at: datetime
- 入库规则:
  - 当AWB首次出现在订单创建环节时，记录order_batch_no归属
  - 当AWB首次出现在出库环节时，补充outbound_batch_no归属
  - AWB的归属允许存在仅“下单批次”或仅“出库批次”的场景，统计时按需取数

2) 订单状态口径
- 最新状态唯一:每个订单以最新有效状态参与统计，保证同一订单不会同时计入多个状态
- AWB维度统计:订单归属到AWB维度后，按状态对订单进行计数
- 取消/退件/丢件/销毁:按最新状态归档，不与“完成”重复计数

3) 去重与分包合并
- 多订单同AWB(合单):按订单去重计数；重量累计以包裹维度求和
- 单订单多AWB(分包/拆分):“出库订单量”仍按订单唯一去重；“出库重量”按各AWB的包裹称重累计
- 同一订单重复出库(异常重发):仅以最新一次有效出库记录参与统计；旧记录标记为无效

4) 重量统计口径
- 统一使用出库称重的标准重量(WeightKG)，缺失时以补录重量或均值估算法标记为“估算”，并在界面显示“估算”标签
- 0或负值重量视为异常，剔除并记录异常日志

5) 时间窗口与幂等
- 支持按时间窗口过滤(创建时间/出库时间)
- 统计过程为幂等：同一参数重复统计结果一致；对迟到数据采用增量刷新

---

## 页面改造与文案
- 批次总览页面的“订单状态-数量”改为按SupplierAWB维度统计展示
- 指标区域新增:
  - 下单批次-出库订单量
  - 下单批次-出库重量/KG
- 指标重命名:
  - 出库订单量→出库批次-出库订单量
  - 出库重量/KG→出库批次-出库重量/KG
- 过滤条件新增:
  - 批次类型:下拉选项[下单批次|出库批次]
  - 批次号:输入框/下拉搜索
  - 供应商:下拉(可多选)
  - 时间窗口:日期区间(按创建/出库时间)

---

## Mermaid流程图(统计管道)

```mermaid
flowchart TD
    A[订单/包裹数据] --> B{归属SupplierAWB}
    B -->|首次创建| C[记录AWB↔下单批次映射]
    B -->|首次出库| D[记录AWB↔出库批次映射]
    A --> E[订单最新状态计算]
    E --> F[状态唯一化(订单维度)]
    F --> G[按AWB聚合状态数量]

    C --> H[下单批次-出库订单量]
    C --> I[下单批次-出库重量/KG]

    D --> J[出库批次-出库订单量]
    D --> K[出库批次-出库重量/KG]

    A --> L[重量清洗/异常剔除]
    L --> I
    L --> K
```

---

## 字段与接口

### 字段表(核心)
| 字段 | 描述 | 口径/规则 |
|---|---|---|
| awb | 供应商运单号 | 唯一值，主维度 |
| order_batch_no | 下单批次号 | 首次创建时记录 |
| outbound_batch_no | 出库批次号 | 首次出库时记录 |
| order_id | 订单ID | 订单维度去重 |
| package_id | 包裹ID | 重量累计维度 |
| latest_status | 最新订单状态 | 状态唯一参与统计 |
| weight_kg | 包裹出库重量 | 异常清洗/估算标签 |
| supplier | 供应商 | 过滤条件 |
| created_at | 创建时间 | 时间窗口过滤 |
| outbound_at | 出库时间 | 时间窗口过滤 |

### 指标表
| 指标 | 维度 | 计算公式 |
|---|---|---|
| 订单状态-数量 | AWB | count(distinct order_id by latest_status) |
| 下单批次-出库订单量 | OrderBatchNo | count(distinct order_id where outbound exists and awb in batch) |
| 下单批次-出库重量/KG | OrderBatchNo | sum(weight_kg where outbound exists and awb in batch) |
| 出库批次-出库订单量 | OutboundBatchNo | count(distinct order_id where awb in batch) |
| 出库批次-出库重量/KG | OutboundBatchNo | sum(weight_kg where awb in batch) |

### 接口设计
- GET /api/batch-overview
  - 入参: batchType(order|outbound), batchNo, supplier(optional), timeFrom(optional), timeTo(optional), page, pageSize
  - 出参: 指标汇总+明细列表(按AWB维度)
- GET /api/batch-overview/status-count
  - 入参: supplier(optional), timeFrom, timeTo
  - 出参: 每个AWB的订单状态数量分布

---

## 异常流程与纠偏
- 缺失AWB:标记“未归属AWB”，统计中剔除，导出异常清单供修复
- AWB重复(供应商侧重号):以AWB+供应商唯一，发现重复时自动合并且保留最新出库记录，历史记录转档
- AWB变更(换单):保留旧AWB映射并建立新AWB映射，订单状态迁移到新AWB，旧AWB仅用于审计
- 单订单多AWB:订单计数去重(按订单ID)，重量按包裹累计到各AWB
- 重量为0或缺失:标记估算并计入“估算权重”，界面显示提示
- 取消后重启履约:以最新状态参与统计，旧状态不再计数

---

## 验收标准
1. **订单状态-数量统计**:
   - 必须以**供应商运单号(SupplierAWB)**作为唯一统计维度
   - 能够准确展示当前供应商运单号下的订单包裹状态分布（如：生成/揽收/出库/完成/取消等）
   - 消除人工合并同AWB数据的需求，界面直接展示聚合后的状态计数
2. **新增与优化字段**:
   - 批次总览页面新增列：【下单批次-出库订单量】与【下单批次-出库重量/KG】
   - 统计数据必须准确无误，与WMS/TMS系统数据保持一致
   - 原有字段重命名完成：【出库订单量】→【出库批次-出库订单量】，【出库重量/KG】→【出库批次-出库重量/KG】
3. **数据一致性**:
   - 与手工Excel对账的差异≤0.1%
   - 同参重复查询结果一致（幂等性）

---

## 优先级、量级、风险
- 优先级:P0(必须)
- 需求量级:日均1万AWB/5万订单；高峰期翻倍
- 风险:
  - 供应商侧AWB重复/换单导致归属混乱→通过AWB+供应商唯一与换单迁移规则兜底
  - 多AWB与多包裹导致计数与重量口径不一致→严格订单去重与包裹累计
  - 迟到数据导致统计延迟→增量刷新与审计导出作为补救

---

## 使用场景
- 场景1:运营查看某下单批次的出库执行情况(订单量与重量)，快速评估履约进度
- 场景2:财务对出库批次的货重进行抽检与对账，核对与承运商账单
- 场景3:中台按供应商维度查看订单状态分布，定位异常AWB(丢件/退件)

---

## 验证与发布
- 对比手工合并样本，验证5个批次(下单/出库各5)的差异率与性能指标
- 上线前进行数据历史回填(近90天)，生成AWB_Batch_Map初始表
- 发布后监控异常日志与接口耗时，连续一周周报归档

